<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.comet.service.eh.abc.dao.Abc00400DAO">

	<select id="selectAbc00400MstModelList" resultType="com.douzone.comet.service.eh.abc.models.Abc00400MstModel">		
		SELECT   ECRM.COMPANY_CD 
				,ECRM.CRCT_TRMT_NO 
				,ECRM.SQ_NO 
				,ECRM.CRCT_TRMT_NM 
				,ECRM.CRCT_TRMT_REQN_DT
				,ECRM3.REVIEW_RST_FG 
				,ECD.MNG_DTL_NM AS REVIEW_RST_NM
		FROM EH_CRCTTRMT_REQN_MST ECRM
			INNER JOIN (SELECT   ECRM.COMPANY_CD 
								,ECRM.CRCT_TRMT_NO 
								,MAX(ECRM.SQ_NO) AS SQ_NO
						FROM EH_CRCTTRMT_REQN_MST ECRM
						GROUP BY ECRM.COMPANY_CD, ECRM.CRCT_TRMT_NO) ECRM2
				ON ECRM2.COMPANY_CD=ECRM.COMPANY_CD 
				AND ECRM2.CRCT_TRMT_NO=ECRM.CRCT_TRMT_NO 
				AND ECRM2.SQ_NO=ECRM.SQ_NO
			LEFT OUTER JOIN EH_CRCTTRMT_REVIEW_MST ECRM3
				ON ECRM3.COMPANY_CD = ECRM.COMPANY_CD 
				AND ECRM3.CRCT_TRMT_NO = ECRM.CRCT_TRMT_NO 
				AND ECRM3.SQ_NO = ECRM.SQ_NO 
			LEFT OUTER JOIN EH_CODE_DTL ECD
				ON ECRM3.REVIEW_RST_FG = ECD.MNG_DTL_CD 
				AND ECRM3.COMPANY_CD = ECD.COMPANY_CD 
				AND ECD.MCLS_CD = 'M0300'
		WHERE 1 = 1		
		<if test='P_COMPANY_CD != null and P_COMPANY_CD != "" '>
			AND ECRM.COMPANY_CD = #{P_COMPANY_CD}
		</if>
		<if test='P_CRCT_TRMT_NM != null and P_CRCT_TRMT_NM != "" '>
			AND ECRM.CRCT_TRMT_NM LIKE CONCAT(CONCAT('%',#{P_CRCT_TRMT_NM}), '%')
		</if>
		<if test='( P_CRCT_TRMT_REQN_DT_START != null and P_CRCT_TRMT_REQN_DT_START != "" ) or ( P_CRCT_TRMT_REQN_DT_END != null and P_CRCT_TRMT_REQN_DT_END != "" )'>
			AND ECRM.CRCT_TRMT_REQN_DT BETWEEN NVL( #{P_CRCT_TRMT_REQN_DT_START}, '00000000') AND NVL( #{P_CRCT_TRMT_REQN_DT_END}, '99999999') 
		</if>
		<if test='P_REVIEW_RST_FG != null and P_REVIEW_RST_FG != "" '>
			AND ECRM3.REVIEW_RST_FG = #{P_REVIEW_RST_FG}	
		</if>	
	</select>
	
	<select id="selectAbc00400DtlModelList" resultType="com.douzone.comet.service.eh.abc.models.Abc00400DtlModel">		
		SELECT ECRM.COMPANY_CD 
		      ,ECRM.CRCT_TRMT_NO
		      ,ECRM.SQ_NO
		      ,ECRM.PLANT_CD
		      ,ECRM.CRCT_TRMT_REQN_DT AS REQN_CRCT_TRMT_REQN_DT
		      ,ECRM.ISSUE_TP AS REQN_ISSUE_TP
		      ,ECRM.CRCT_TRMT_NM AS REQN_CRCT_TRMT_NM
		      ,ECRM.TRMT_GOAL_DT AS REQN_TRMT_GOAL_DT
		      ,ECRM.TRMT_TRGT_CD AS REQN_TRMT_TRGT_CD
		      ,ECRM.ISSUE_EMP_NO AS REQN_ISSUE_EMP_NO	
		      ,ECRM.REL_BSS_TXT AS REQN_REL_BSS_TXT
		      ,ECRM.PTG_MATTER_TXT AS REQN_PTG_MATTER_TXT
		      ,ECRM.CRCT_TRMT_TXT AS REQN_CRCT_TRMT_TXT
		      ,ECRM.FG_CD AS REQN_FG_CD
		      ,ECRM.ATCHFILE_ID AS REQN_ATCHFILE_ID
		      ,ECRM.IMG_PATH_DC AS REQN_IMG_PATH_DC
		      ,MPM.PLANT_NM AS REQN_PLANT_NM
		      ,ECD.MNG_DTL_NM AS REQN_ISSUE_NM
		      ,MDM2.DEPT_NM AS REQN_TRMT_TRGT_NM
		      ,HEM2.KOR_NM AS REQN_ISSUE_EMP_NM
		      ,ECD2.MNG_DTL_NM AS REQN_FG_NM
		      ,HEM2.DEPT_CD AS REQN_ISSUE_DEPT_CD
		      ,MDM3.DEPT_NM AS REQN_ISSUE_DEPT_NM
		      ,HEM2.PSTN_CD AS REQN_ISSUE_EMP_PSTN_CD
		      ,CFI3.FILE_DC AS REQN_FILE_DC
			  ,CFI4.FILE_DC AS REQN_IMG_FILE_DC
		      ,ECRM2.COMPANY_CD AS RST_COMPANY_CD
		      ,ECRM2.CRCT_TRMT_NO AS RST_CRCT_TRMT_NO
		      ,ECRM2.SQ_NO AS RST_SQ_NO
		      ,ECRM2.ISSUE_EMP_NO AS RST_ISSUE_EMP_NO
		      ,ECRM2.ISSUE_DT AS RST_ISSUE_DT
		      ,ECRM2.SURCHRG_AMT AS RST_SURCHRG_AMT
		      ,ECRM2.CUS_ANAL_TXT AS RST_CUS_ANAL_TXT
		      ,ECRM2.TRMT_CNTN_TXT AS RST_TRMT_CNTN_TXT
		      ,ECRM2.PRVN_TRMT_N_CTMSR_TXT AS RST_PRVN_TRMT_N_CTMSR_TXT
		      ,ECRM2.ATCHFILE_ID AS RST_ATCHFILE_ID
		      ,ECRM2.IMG_PATH_DC AS RST_IMG_PATH_DC
		      ,HEM.KOR_NM AS RST_ISSUE_EMP_NM
		      ,MDM.DEPT_CD AS RST_ISSUE_DEPT_CD
		      ,MDM.DEPT_NM AS RST_ISSUE_DEPT_NM
		      ,CFI.FILE_DC AS RST_FILE_DC
			  ,CFI2.FILE_DC AS RST_IMG_FILE_DC
			  ,ECRM3.COMPANY_CD AS REVIEW_COMPANY_CD
			  ,ECRM3.CRCT_TRMT_NO AS REVIEW_CRCT_TRMT_NO
			  ,ECRM3.SQ_NO AS REVIEW_SQ_NO
			  ,ECRM3.ISSUE_EMP_NO AS REVIEW_ISSUE_EMP_NO
			  ,ECRM3.ISSUE_DT AS REVIEW_ISSUE_DT
			  ,ECRM3.RE_CRCT_TRMT_TXT AS REVIEW_RE_CRCT_TRMT_TXT
			  ,ECRM3.RE_CRCT_TRMT_REQN_DT AS REVIEW_RE_CRCT_TRMT_REQN_DT
			  ,ECRM3.REVIEW_OPN_TXT AS REVIEW_OPN_TXT
			  ,ECRM3.REVIEW_RST_FG AS REVIEW_RST_FG
			  ,HEM3.KOR_NM AS REVIEW_ISSUE_EMP_NM
			  ,ECD3.MNG_DTL_NM AS REVIEW_RST_NM
			  ,MDM4.DEPT_CD AS REVIEW_ISSUE_DEPT_CD
			  ,MDM4.DEPT_NM AS REVIEW_ISSUE_DEPT_NM
		FROM EH_CRCTTRMT_REQN_MST ECRM
		LEFT OUTER JOIN EH_CRCTTRMT_RST_MST ECRM2
			ON ECRM.COMPANY_CD = ECRM2.COMPANY_CD 
			AND ECRM.CRCT_TRMT_NO = ECRM2.CRCT_TRMT_NO 
			AND ECRM.SQ_NO = ECRM2.SQ_NO 
		LEFT OUTER JOIN EH_CRCTTRMT_REVIEW_MST ECRM3
			ON ECRM.COMPANY_CD = ECRM3.COMPANY_CD 
			AND ECRM.CRCT_TRMT_NO = ECRM3.CRCT_TRMT_NO 
			AND ECRM.SQ_NO = ECRM3.SQ_NO  
		LEFT OUTER JOIN EH_CODE_DTL ECD
			ON ECRM.ISSUE_TP = ECD.MNG_DTL_CD
			AND ECRM.COMPANY_CD = ECD.COMPANY_CD 
			AND ECD.MCLS_CD = 'M0100'
		LEFT OUTER JOIN EH_CODE_DTL ECD2
			ON ECRM.FG_CD = ECD2.MNG_DTL_CD 
			AND ECRM.COMPANY_CD = ECD2.COMPANY_CD 
			AND ECD2.MCLS_CD = 'M0200' 
		LEFT OUTER JOIN EH_CODE_DTL ECD3
			ON ECRM3.REVIEW_RST_FG = ECD3.MNG_DTL_CD 
			AND ECRM3.COMPANY_CD = ECD3.COMPANY_CD 
			AND ECD3.MCLS_CD = 'M0300' 
		LEFT OUTER JOIN MA_PLANT_MST MPM
			ON ECRM.COMPANY_CD = MPM.COMPANY_CD 
			AND ECRM.PLANT_CD = MPM.PLANT_CD 
		LEFT OUTER JOIN HR_EMP_MST HEM
			ON ECRM2.COMPANY_CD = HEM.COMPANY_CD 
			AND ECRM2.ISSUE_EMP_NO = HEM.EMP_NO
		LEFT OUTER JOIN HR_EMP_MST HEM2
			ON ECRM.COMPANY_CD = HEM2.COMPANY_CD 
			AND ECRM.ISSUE_EMP_NO = HEM2.EMP_NO
		LEFT OUTER JOIN HR_EMP_MST HEM3
			ON ECRM3.COMPANY_CD = HEM3.COMPANY_CD 
			AND ECRM3.ISSUE_EMP_NO = HEM3.EMP_NO
		LEFT OUTER JOIN MA_DEPT_MST MDM
			ON MDM.COMPANY_CD = HEM.COMPANY_CD 
			AND MDM.DEPT_CD = HEM.DEPT_CD 
			AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN MDM.DEPT_START_DT AND NVL(MDM.DEPT_END_DT, TO_CHAR(SYSDATE, 'YYYYMMDD'))
		LEFT OUTER JOIN MA_DEPT_MST MDM2
			ON MDM2.COMPANY_CD = ECRM.COMPANY_CD 
			AND MDM2.DEPT_CD = ECRM.TRMT_TRGT_CD
			AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN MDM2.DEPT_START_DT AND NVL(MDM2.DEPT_END_DT, TO_CHAR(SYSDATE, 'YYYYMMDD'))
		LEFT OUTER JOIN MA_DEPT_MST MDM3
			ON MDM3.COMPANY_CD = HEM2.COMPANY_CD 
			AND MDM3.DEPT_CD = HEM2.DEPT_CD 
			AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN MDM3.DEPT_START_DT AND NVL(MDM3.DEPT_END_DT, TO_CHAR(SYSDATE, 'YYYYMMDD'))
		LEFT OUTER JOIN MA_DEPT_MST MDM4
			ON MDM4.COMPANY_CD = HEM3.COMPANY_CD 
			AND MDM4.DEPT_CD = HEM3.DEPT_CD 
			AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN MDM4.DEPT_START_DT AND NVL(MDM4.DEPT_END_DT, TO_CHAR(SYSDATE, 'YYYYMMDD'))
		LEFT OUTER JOIN ( SELECT FILE_DC, MAX(INSERT_DTS) INSERT_DTS FROM CM_FILE_INFO GROUP BY FILE_DC ) CFI
			ON CFI.FILE_DC = ECRM2.ATCHFILE_ID
		LEFT OUTER JOIN CM_FILE_INFO CFI2
			ON CFI2.FILE_DC = ECRM2.IMG_PATH_DC 
			AND CFI2.COMPANY_CD = ECRM2.COMPANY_CD
		LEFT OUTER JOIN ( SELECT FILE_DC, MAX(INSERT_DTS) INSERT_DTS FROM CM_FILE_INFO GROUP BY FILE_DC ) CFI3
			ON CFI3.FILE_DC = ECRM.ATCHFILE_ID
		LEFT OUTER JOIN CM_FILE_INFO CFI4
			ON CFI4.FILE_DC = ECRM.IMG_PATH_DC 
			AND CFI4.COMPANY_CD = ECRM.COMPANY_CD
		WHERE 1 = 1
			AND ECRM.COMPANY_CD = #{P_COMPANY_CD}
			AND ECRM.CRCT_TRMT_NO = #{P_CRCT_TRMT_NO}
	</select>

</mapper>
