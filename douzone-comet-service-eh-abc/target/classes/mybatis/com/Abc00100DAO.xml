<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.douzone.comet.service.eh.abc.dao.Abc00100DAO">
	<select id="selectAbc00100ModelList" parameterType="hashmap" resultType="com.douzone.comet.service.eh.abc.models.Abc00100Model">		
		SELECT	 ECRM.COMPANY_CD  
				,ECRM.CRCT_TRMT_NO
				,ECRM.SQ_NO
				,ECRM.CRCT_TRMT_TP 
				,ECRM.ISSUE_FG 
				,ECRM.PLANT_CD 
				,ECRM.CRCT_TRMT_REQN_DT	
				,ECRM.ACTION_PLAN_NO 
				,ECRM.ISSUE_CD 
				,ECRM.ISSUE_TP 
				,ECRM.REL_STD_CD 
				,ECRM.NOTI_NO 
				,ECRM.ACTV_FG 
				,ECRM.OCRN_CUS_CD 
				,ECRM.CRCT_TRMT_NM
				,ECRM.TRMT_GOAL_DT
				,ECRM.USE_TM_CNT 
				,ECRM.TRMT_TRGT_CD 
				,ECRM.REL_DEPT_CD 
				,ECRM.ISSUE_EMP_NO
				,ECRM.REL_BSS_TXT
				,ECRM.PTG_MATTER_TXT
				,ECRM.CRCT_TRMT_TXT
				,ECRM.FG_CD
				,ECRM.ATCHFILE_ID
				,ECRM.IMG_PATH_DC
				,ECRM.INSERT_ID 
				,ECRM.INSERT_DTS 
				,ECRM.UPDATE_ID 
				,ECRM.UPDATE_DTS
				,ECD.MNG_DTL_CD
				,ECD.MNG_DTL_NM AS ISSUE_NM	
				,ECD2.MNG_DTL_CD
				,ECD2.MNG_DTL_NM AS FG_NM 
				,MPM.PLANT_NM
				,MDM.DEPT_NM AS TRMT_TRGT_NM
				,HEM.KOR_NM AS ISSUE_EMP_NM
				,HEM.DEPT_CD AS ISSUE_DEPT_CD
				,MDM2.DEPT_NM AS ISSUE_DEPT_NM
				,HEM.PSTN_CD
				,CFI.FILE_DC 
				,CFI.INSERT_DTS
				,CFI2.FILE_DC AS FILE_IMG_DC
				,CFI2.FILE_SQ AS FILE_IMG_SQ
				,CFI2.ORGL_FILE_DC AS FILE_IMG_ORGL_FILE_DC
				,CFI2.ORGL_FEXTSN_DC AS FILE_IMG_ORGL_FEXTSN_DC
				,CFI2.NEW_FILE_DC AS FILE_IMG_NEW_FILE_DC
				,CFI2.FILE_VR AS FILE_IMG_FILE_VR
				,CFI3.FILE_DC AS RST_FILE_DC
				,CFI3.INSERT_DTS AS RST_INSERT_DTS
				,CFI4.FILE_DC AS RST_FILE_IMG_DC
				,CFI4.FILE_SQ AS RST_FILE_IMG_SQ
				,CFI4.ORGL_FILE_DC AS RST_FILE_IMG_ORGL_FILE_DC
				,CFI4.ORGL_FEXTSN_DC AS RST_FILE_IMG_ORGL_FEXTSN_DC
				,CFI4.NEW_FILE_DC AS RST_FILE_IMG_NEW_FILE_DC
				,CFI4.FILE_VR AS RST_FILE_IMG_FILE_VR
				,ECRM3.REVIEW_RST_FG
				,ECD3.MNG_DTL_NM AS REVIEW_RST_FG_NM
		FROM @{dzparam_dbname}EH_CRCTTRMT_REQN_MST ECRM
			LEFT OUTER JOIN EH_CRCTTRMT_RST_MST ECRM2
				ON ECRM2.COMPANY_CD = ECRM.COMPANY_CD 
				AND ECRM2.CRCT_TRMT_NO = ECRM.CRCT_TRMT_NO 
				AND ECRM2.SQ_NO = ECRM.SQ_NO
			LEFT OUTER JOIN EH_CRCTTRMT_REVIEW_MST ECRM3
				ON ECRM3.COMPANY_CD = ECRM.COMPANY_CD 
				AND ECRM3.CRCT_TRMT_NO = ECRM.CRCT_TRMT_NO 
				AND ECRM3.SQ_NO = ECRM.SQ_NO				
			LEFT OUTER JOIN EH_CODE_DTL ECD
				ON ECRM.ISSUE_TP = ECD.MNG_DTL_CD
				AND ECRM.COMPANY_CD = ECD.COMPANY_CD 
				AND ECD.MCLS_CD = 'M0100'
			LEFT OUTER JOIN EH_CODE_DTL ECD2
				ON ECRM.FG_CD = ECD2.MNG_DTL_CD 
				AND ECRM.COMPANY_CD = ECD2.COMPANY_CD 
				AND ECD2.MCLS_CD = 'M0200' 
			LEFT OUTER JOIN EH_CODE_DTL ECD3
				ON ECRM3.REVIEW_RST_FG = ECD3.MNG_DTL_CD 
				AND ECRM3.COMPANY_CD = ECD3.COMPANY_CD 
				AND ECD3.MCLS_CD = 'M0300' 
			LEFT OUTER JOIN MA_PLANT_MST MPM
				ON ECRM.COMPANY_CD = MPM.COMPANY_CD 
				AND ECRM.PLANT_CD = MPM.PLANT_CD 
			LEFT OUTER JOIN MA_DEPT_MST MDM
				ON MDM.COMPANY_CD = ECRM.COMPANY_CD 
				AND MDM.DEPT_CD = ECRM.TRMT_TRGT_CD
				AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN MDM.DEPT_START_DT AND NVL(MDM.DEPT_END_DT, TO_CHAR(SYSDATE, 'YYYYMMDD'))
			LEFT OUTER JOIN HR_EMP_MST HEM
				ON ECRM.COMPANY_CD = HEM.COMPANY_CD 
				AND ECRM.ISSUE_EMP_NO = HEM.EMP_NO
			LEFT OUTER JOIN MA_DEPT_MST MDM2
				ON MDM2.COMPANY_CD = HEM.COMPANY_CD 
				AND MDM2.DEPT_CD = HEM.DEPT_CD 
				AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN MDM2.DEPT_START_DT AND NVL(MDM2.DEPT_END_DT, TO_CHAR(SYSDATE, 'YYYYMMDD'))
			LEFT OUTER JOIN ( SELECT FILE_DC, MAX(INSERT_DTS) INSERT_DTS FROM CM_FILE_INFO GROUP BY FILE_DC ) CFI
				ON ECRM.ATCHFILE_ID = CFI.FILE_DC
			LEFT OUTER JOIN CM_FILE_INFO CFI2
				ON CFI2.FILE_DC = ECRM.IMG_PATH_DC
			LEFT OUTER JOIN ( SELECT FILE_DC, MAX(INSERT_DTS) INSERT_DTS FROM CM_FILE_INFO GROUP BY FILE_DC ) CFI3
				ON ECRM2.ATCHFILE_ID = CFI3.FILE_DC
			LEFT OUTER JOIN CM_FILE_INFO CFI4
				ON CFI4.FILE_DC = ECRM2.IMG_PATH_DC
			WHERE 1 = 1
				AND (ECRM3.REVIEW_RST_FG != '301' OR ECRM3.REVIEW_RST_FG IS NULL)
			<if test='P_COMPANY_CD != null and P_COMPANY_CD != "" '>
				AND ECRM.COMPANY_CD = #{P_COMPANY_CD}
			</if>
			<if test='P_PLANT_CD != null and P_PLANT_CD != "" '>
				AND ECRM.PLANT_CD = #{P_PLANT_CD}
			</if>
			<if test='P_ISSUE_TP != null and P_ISSUE_TP != "" '>
				AND ECRM.ISSUE_TP = #{P_ISSUE_TP}
			</if>
			<if test='P_FG_CD != null and P_FG_CD != "" '>
				AND ECRM.FG_CD = #{P_FG_CD}
			</if>
			<if test='P_CRCT_TRMT_REQN_DT != null and P_CRCT_TRMT_REQN_DT != "" '>
				AND ECRM.CRCT_TRMT_REQN_DT = #{P_CRCT_TRMT_REQN_DT}
			</if>
			<if test='P_CRCT_TRMT_NO != null and P_CRCT_TRMT_NO != "" '>
				AND ECRM.CRCT_TRMT_NO LIKE CONCAT(CONCAT('%',#{P_CRCT_TRMT_NO}), '%')  
			</if>
	</select>

	<select id="selectMaxSq" parameterType="hashmap" resultType="int">		
		SELECT NVL(TO_NUMBER(SUBSTR(MAX(CRCT_TRMT_NO),11)),0) + 1 AS CRCT_TRMT_NO
		FROM EH_CRCTTRMT_REQN_MST
		WHERE COMPANY_CD = #{P_COMPANY_CD}
			AND PLANT_CD = #{P_PLANT_CD}
			AND SUBSTR(CRCT_TRMT_NO,1,6) = #{P_NOWDATE}	
	</select>
	
	<select id="selectMaxSqNo" parameterType="hashmap" resultType="int">		
		SELECT NVL(TO_NUMBER(MAX(SQ_NO)), 0) + 1 AS SQ_NO
		FROM EH_CRCTTRMT_REQN_MST
		WHERE COMPANY_CD = #{P_COMPANY_CD}
			AND CRCT_TRMT_NO = #{P_CRCT_TRMT_NO}
	</select>

	<insert id="insertAbc00100Model">		
		INSERT INTO @{dzparam_dbname}EH_CRCTTRMT_REQN_MST (
				COMPANY_CD
				,CRCT_TRMT_NO
				,SQ_NO
				,CRCT_TRMT_TP
				,ISSUE_FG
				,PLANT_CD
				,CRCT_TRMT_REQN_DT
				,ACTION_PLAN_NO
				,ISSUE_CD
				,ISSUE_TP
				,REL_STD_CD
				,NOTI_NO
				,ACTV_FG
				,OCRN_CUS_CD
				,CRCT_TRMT_NM
				,TRMT_GOAL_DT
				,USE_TM_CNT
				,TRMT_TRGT_CD
				,REL_DEPT_CD
				,ISSUE_EMP_NO
				,REL_BSS_TXT
				,PTG_MATTER_TXT
				,CRCT_TRMT_TXT
				,FG_CD
				,ATCHFILE_ID
				,IMG_PATH_DC
				,INSERT_ID
				,INSERT_DTS
				,UPDATE_ID
				,UPDATE_DTS
		) VALUES (
				#{P_COMPANY_CD}
				,#{P_CRCT_TRMT_NO}
				,#{P_SQ_NO}
				,#{P_CRCT_TRMT_TP}
				,#{P_ISSUE_FG}
				,#{P_PLANT_CD}
				,#{P_CRCT_TRMT_REQN_DT}
				,#{P_ACTION_PLAN_NO}
				,#{P_ISSUE_CD}
				,#{P_ISSUE_TP}
				,#{P_REL_STD_CD}
				,#{P_NOTI_NO}
				,#{P_ACTV_FG}
				,#{P_OCRN_CUS_CD}
				,#{P_CRCT_TRMT_NM}
				,#{P_TRMT_GOAL_DT}
				,#{P_USE_TM_CNT}
				,#{P_TRMT_TRGT_CD}
				,#{P_REL_DEPT_CD}
				,#{P_ISSUE_EMP_NO}
				,#{P_REL_BSS_TXT}
				,#{P_PTG_MATTER_TXT}
				,#{P_CRCT_TRMT_TXT}
				,#{P_FG_CD}
				,#{P_ATCHFILE_ID}
				,#{P_IMG_PATH_DC}
				,#{P_INSERT_ID}
				,#{P_INSERT_DTS}
				,#{P_UPDATE_ID}
				,#{P_UPDATE_DTS}
		)		
	</insert>
	
	<insert id="insertAbc00200Model">		
		INSERT INTO @{dzparam_dbname}EH_CRCTTRMT_RST_MST (
				COMPANY_CD
				,CRCT_TRMT_NO
				,SQ_NO
				,TRMT_TM_CNT
				,WRT_TM_CNT
		) VALUES (
				#{P_COMPANY_CD}
				,#{P_CRCT_TRMT_NO}
				,#{P_SQ_NO}
				,#{P_TRMT_TM_CNT}
				,#{P_WRT_TM_CNT}
		)		
	</insert>
	
	<insert id="insertAbc00300Model">		
		INSERT INTO @{dzparam_dbname}EH_CRCTTRMT_REVIEW_MST (
				COMPANY_CD
				,CRCT_TRMT_NO
				,SQ_NO
		) VALUES (
				#{P_COMPANY_CD}
				,#{P_CRCT_TRMT_NO}
				,#{P_SQ_NO}
		)		
	</insert>

	<update id="updateAbc00100Model" >		
		UPDATE	@{dzparam_dbname}EH_CRCTTRMT_REQN_MST
		SET		CRCT_TRMT_TP = #{P_CRCT_TRMT_TP}
				,ISSUE_FG = #{P_ISSUE_FG}
				,PLANT_CD = #{P_PLANT_CD}
				,CRCT_TRMT_REQN_DT = #{P_CRCT_TRMT_REQN_DT}
				,ACTION_PLAN_NO = #{P_ACTION_PLAN_NO}
				,ISSUE_CD = #{P_ISSUE_CD}
				,ISSUE_TP = #{P_ISSUE_TP}
				,REL_STD_CD = #{P_REL_STD_CD}
				,NOTI_NO = #{P_NOTI_NO}
				,ACTV_FG = #{P_ACTV_FG}
				,OCRN_CUS_CD = #{P_OCRN_CUS_CD}
				,CRCT_TRMT_NM = #{P_CRCT_TRMT_NM}
				,TRMT_GOAL_DT = #{P_TRMT_GOAL_DT}
				,USE_TM_CNT = #{P_USE_TM_CNT}
				,TRMT_TRGT_CD = #{P_TRMT_TRGT_CD}
				,REL_DEPT_CD = #{P_REL_DEPT_CD}
				,ISSUE_EMP_NO = #{P_ISSUE_EMP_NO}
				,REL_BSS_TXT = #{P_REL_BSS_TXT}
				,PTG_MATTER_TXT = #{P_PTG_MATTER_TXT}
				,CRCT_TRMT_TXT = #{P_CRCT_TRMT_TXT}
				,FG_CD = #{P_FG_CD}
				,ATCHFILE_ID = #{P_ATCHFILE_ID}
				,IMG_PATH_DC = #{P_IMG_PATH_DC}
				,UPDATE_ID = #{P_UPDATE_ID}
				,UPDATE_DTS = #{P_UPDATE_DTS}
		WHERE	1 = 1
			AND	COMPANY_CD = #{P_COMPANY_CD}
			AND	CRCT_TRMT_NO = #{P_CRCT_TRMT_NO}	
			AND	SQ_NO = #{P_SQ_NO}			
	</update>

	<delete id="deleteAbc00100Model">		
		DELETE
		FROM	@{dzparam_dbname}EH_CRCTTRMT_REQN_MST
		WHERE	1 = 1
			AND	COMPANY_CD = #{P_COMPANY_CD}
			AND	CRCT_TRMT_NO = #{P_CRCT_TRMT_NO}	
			AND	SQ_NO = #{P_SQ_NO}	
	</delete>
	
	<delete id="deleteAbc00200Model">		
		DELETE
		FROM	@{dzparam_dbname}EH_CRCTTRMT_RST_MST
		WHERE	1 = 1
			AND	COMPANY_CD = #{P_COMPANY_CD}
			AND	CRCT_TRMT_NO = #{P_CRCT_TRMT_NO}	
			AND	SQ_NO = #{P_SQ_NO}	
	</delete>
	
	<delete id="deleteAbc00300Model">		
		DELETE
		FROM	@{dzparam_dbname}EH_CRCTTRMT_REVIEW_MST
		WHERE	1 = 1
			AND	COMPANY_CD = #{P_COMPANY_CD}
			AND	CRCT_TRMT_NO = #{P_CRCT_TRMT_NO}	
			AND	SQ_NO = #{P_SQ_NO}	
	</delete>
	
</mapper>
